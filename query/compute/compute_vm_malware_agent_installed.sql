with all_vm as (
  select
  '${azurerm_virtual_machine.' || name || '.id}' as id,
  *
  from
    terraform_resource
  where
    type = 'azurerm_virtual_machine'
), vm_extensions as (
    select
      *
    from
      terraform_resource
    where
      type = 'azurerm_virtual_machine_extension'
),
vm_amtimalware_extension as (
  select
    a.id,
    b.arguments ->> 'virtual_machine_id' as vm_id
  from
    all_vm as a left join vm_extensions as b on  (b.arguments ->> 'virtual_machine_id') = a.id
  where
    (b.arguments ->> 'publisher') = 'Microsoft.Azure.Security'
    and (b.arguments ->> 'type') = 'IaaSAntimalware'
)
select
  -- Required Columns
  type || ' ' || name as resource,
  case
    when d.id is null then 'alarm'
    else 'ok'
  end as status,
  name || case
    when d.id is null then ' IaaSAntimalware extension not installed'
    else ' IaaSAntimalware extension installed'
  end || '.' reason,
  path
from
  all_vm as c left join vm_amtimalware_extension as d on c.id = d.vm_id;